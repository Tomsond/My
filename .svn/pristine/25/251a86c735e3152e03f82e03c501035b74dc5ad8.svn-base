package com.thinkive.fxc.ismp.bus.business.smjjCancel.function;

import java.util.Date;
import java.util.List;

import com.thinkive.base.jdbc.DataRow;
import com.thinkive.base.util.DateHelper;
import com.thinkive.fxc.ismp.bus.base.business.constants.BusinessServiceBeanIdConstants;
import com.thinkive.fxc.ismp.bus.base.business.service.UserInfoService;
import com.thinkive.fxc.ismp.bus.base.business.vo.UserInfoVo;
import com.thinkive.fxc.ismp.bus.base.common.ISMPBaseFunction;
import com.thinkive.fxc.ismp.bus.base.constants.DictionaryConstants;
import com.thinkive.fxc.ismp.bus.business.util.DataFormatUtils;
import com.thinkive.fxc.ismp.bus.third.constants.ThirdDictionaryConstants;
import com.thinkive.fxc.ismp.bus.third.constants.ThirdInterfaceConstant;
import com.thinkive.fxc.ismp.bus.third.service.ThirdInterface;
import com.thinkive.server.ResultVo;
import com.thinkive.server.util.SpringUtil;

/**
 * @描述: 私募基金合格投资者取消--前置条件检查
 * @版权: Copyright (c) 2019 
 * @公司: 思迪科技 
 * @作者: 江昶
 * @版本: 1.0 
 * @创建日期: 2019年9月17日 
 * @创建时间: 上午11:22:06
 */
public class Function1004227 extends ISMPBaseFunction {

	private UserInfoVo userInfo;
	
	private ThirdInterface thirdInterface;
	
	private UserInfoService userInfoService;
	@SuppressWarnings("unchecked")
	public ResultVo execute() throws Exception {
		ResultVo resultVo = new ResultVo();
		userInfoService = SpringUtil.getBean(BusinessServiceBeanIdConstants.SERVICE_ID_USERINFO, UserInfoService.class);
		userInfo = userInfoService.queryAndCheckUserByUserIdAndType(userId,
				ThirdInterfaceConstant.USER_ACCOUNT_TYPE_ZQ);

		DataRow thirdInput = DataFormatUtils.packThirdInput(userInfo);
		thirdInput.set("branch_no", thirdInput.getString("branchno"));//营业部
		thirdInput.set("money_type", ThirdInterfaceConstant.MONEY_TYPE_RMB);//营业部
		
		thirdInterface = SpringUtil.getBean(ThirdDictionaryConstants.SERVICE_ID_THIRDINTERFACE, ThirdInterface.class);
	
		String is_smjj_flag = DictionaryConstants.BOL_TRUE;//是否是私募合格投资者  默认1是   0不是
		String is_position_flag = DictionaryConstants.BOL_FALSE;//是否有持仓          默认0没有  1有
		
		DataRow result = new DataRow();
        //是否是私募合格投资者
        List<DataRow> isSmjjList = thirdInterface.queryExtsecumAcct(thirdInput);
        String valid_date_flag = DictionaryConstants.BOL_FALSE;
        logger.info("是否是私募合格投资者返回结果："+isSmjjList);
        if (isSmjjList!= null && !isSmjjList.isEmpty()) {
            DataRow dataRow = isSmjjList.get(0);
//            String right_open_date = dataRow.getString("right_open_date");//权限开通日期
            String valid_date = dataRow.getString("valid_date");//有效日期
            Date parseString = DateHelper.parseString(valid_date, "yyyyMMdd");
            Date now =new Date();
             if ( now.getTime() > parseString.getTime())
             {
                 is_smjj_flag = DictionaryConstants.BOL_FALSE;//不是
                 valid_date_flag = DictionaryConstants.BOL_TRUE;//失效
             }     
        }else{
            is_smjj_flag =  DictionaryConstants.BOL_FALSE;//不是
        }
        
        //是否有持仓
        List<DataRow> shareList = thirdInterface.productShare(thirdInput);
        logger.info("私募持仓查询返回结果："+shareList);
        if ( shareList !=null && shareList.size() > 0 )
        {
            for (int i = 0,len = shareList.size(); i<len; i++)
            {
                DataRow shareData = shareList.get(i);
                if ( thirdInput.getString("client_id").equals(shareData.getString("client_id")) )
                {
                    is_position_flag = DictionaryConstants.BOL_TRUE;
                    break;
                }
            }
        }
        
        result.set("is_smjj_flag",is_smjj_flag);
        result.set("valid_date_flag",valid_date_flag);
        result.set("is_position_flag",is_position_flag);
		resultVo.setResult(result);
		resultVo.setErrorNo(DictionaryConstants.INVOKE_FUNCTION_SUCCESS);// 返回成功标示
		resultVo.setErrorMsg(DictionaryConstants.INVOKE_FUNCTION_SUCCESSMSG);
		return resultVo;
	}

}
