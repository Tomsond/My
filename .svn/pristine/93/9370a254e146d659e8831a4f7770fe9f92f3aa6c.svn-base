package com.thinkive.fxc.ismp.bus.business.assets.thirdbank.function;

import java.util.HashMap;
import java.util.List;
import java.util.Map;

import com.thinkive.base.config.Configuration;
import com.thinkive.base.exception.BusinessException;
import com.thinkive.base.jdbc.DataRow;
import com.thinkive.base.util.SpringHelper;
import com.thinkive.fxc.ismp.bus.base.basicdata.model.ThirdBankModel;
import com.thinkive.fxc.ismp.bus.base.business.constants.AgreeNodePropertyConstants;
import com.thinkive.fxc.ismp.bus.base.business.constants.BusinessConstants;
import com.thinkive.fxc.ismp.bus.base.business.constants.BusinessServiceBeanIdConstants;
import com.thinkive.fxc.ismp.bus.base.business.model.AgreeRecordModel;
import com.thinkive.fxc.ismp.bus.base.business.service.AgreeRecordService;
import com.thinkive.fxc.ismp.bus.base.business.service.SignAndVerifyService;
import com.thinkive.fxc.ismp.bus.base.business.service.UserInfoService;
import com.thinkive.fxc.ismp.bus.base.business.service.UserSnapShotService;
import com.thinkive.fxc.ismp.bus.base.business.vo.UserInfoVo;
import com.thinkive.fxc.ismp.bus.base.common.ISMPBaseFunction;
import com.thinkive.fxc.ismp.bus.base.constants.CertConstants;
import com.thinkive.fxc.ismp.bus.base.constants.DictionaryConstants;
import com.thinkive.fxc.ismp.bus.base.constants.ErrorCodeCheckInput;
import com.thinkive.fxc.ismp.bus.base.constants.ErrorCodeSystem;
import com.thinkive.fxc.ismp.bus.business.assets.thirdbank.contants.ThirdBankContants;
import com.thinkive.fxc.ismp.bus.business.assets.thirdbank.contants.ThirdBankErrorCode;
import com.thinkive.fxc.ismp.bus.business.assets.thirdbank.service.ThirdBankService;
import com.thinkive.fxc.ismp.bus.business.assets.thirdbank.vo.ThirdBankBusinessInfoVo;
import com.thinkive.fxc.ismp.bus.business.util.DataFormatUtils;
import com.thinkive.fxc.ismp.bus.third.constants.ThirdDictionaryConstants;
import com.thinkive.fxc.ismp.bus.third.service.ThirdInterface;
import com.thinkive.server.InvokeException;
import com.thinkive.server.ResultVo;

/**
 * @描述:
 * @公司: thinkive
 * @作者: xuzong
 * @时间: 2018/10/25 18:20
 */
public class Function1004182 extends ISMPBaseFunction {


    private Long userId; //用户ID

    private Long businessId; //业务实例ID

    private Long newBankConfigId; //新绑定银行卡对应的三方存管配置编号

    private String cardNum; //银行卡号

    private String cardPassword; //银行卡密码

    private String jsondata; //签名json字符串

    private ThirdBankService thirdBankService;

    private ThirdInterface thirdInterface;

    private UserInfoService userInfoService;

    private UserSnapShotService userSnapShotService;

    private AgreeRecordService agreeRecordService;

    @Override
    public ResultVo execute() throws Exception
    {
        //step1:获取入参并校验
        checkInput();

        //step2:获取业务办理数据
        thirdBankService = SpringHelper.getBean(ThirdBankContants.SERVICE_ID_THIRDBANK, ThirdBankService.class);
        ThirdBankBusinessInfoVo thirdBankBusinessInfoVo = thirdBankService.queryByBusinessId(businessId);
        if (null == thirdBankBusinessInfoVo)
        {
            throw new BusinessException(ErrorCodeSystem.BUSINESS_NOFLOW);//业务办理数据不存在
        }

        ThirdBankModel thirdBankModel = thirdBankService.queryThirdBankModelById(newBankConfigId);//根据ID获取对应银行的三方存管配置信息
        if (thirdBankModel == null)
        {
            throw new BusinessException(ThirdBankErrorCode.NO_BANKCODE);//没有这种三方存管配置
        }
        String newBankCode = thirdBankModel.getBankNo();
        if (newBankCode.equals(thirdBankBusinessInfoVo.getOldBankcode()))
        {
            throw new BusinessException(ThirdBankErrorCode.SAME_BANK_CANNOT__MODIFY);//注销的三方存管银行不能与要绑定的银行一致
        }

        //获取需要提交的协议信息
        Map<String, DataRow> signParamsMap = getNeedSignAgereeInfo(thirdBankModel);
		signParamsMap.remove("dhcgfxjjs");
        //提交的所有需要签署的协议
        SignAndVerifyService signAndVerifyService = SpringHelper.getBean(BusinessServiceBeanIdConstants.SERVICE_ID_SIGNANDVERIFY, SignAndVerifyService.class);
        List<Map<String, String>> allSignList = signAndVerifyService.verifySignTextAndSubmitThird(jsondata, signParamsMap);

        //step3:根据资金账号获取,获取用户和用户账号信息
        String fund_account = thirdBankBusinessInfoVo.getFundAccount();//资金账号
        userInfoService = SpringHelper.getBean(BusinessServiceBeanIdConstants.SERVICE_ID_USERINFO, UserInfoService.class);
        UserInfoVo userInfoVo = userInfoService.queryAndCheckUserByUserIdAndAccount(userId, fund_account);

        //step4:判断是否是中登时间
        thirdBankService.checkTradeTime();

        //step5:判断用户银行卡是否已经绑定三方存管
        thirdBankService.checkCardExit(cardNum, userId);

        //step6:检查银行绑定类型的帐号密码是否需要
        thirdBankService.checkBindBankInfo(thirdBankModel, cardNum, cardPassword);

        //step7:绑定银行卡数量上限验证，目前最多绑定五张银行卡
        thirdBankService.checkBankCount(userInfoVo, ThirdBankContants.THIRDBANK_OP_TYPE_CANCELANDBIND);

        //step7:将银行卡和资金账号进行绑定
        String success_type;//绑定成功方式（0：绑定失败后，自动预指定成功 1：正常绑定成功）
        String bindType = thirdBankModel.getBindType();//三方存管银行签约方式（1：一步式；2：预指定）
        DataRow thirdInput = DataFormatUtils.packThirdInput(userInfoVo);
        thirdInput.set("bank_code", thirdBankModel.getLinkBankOrg());
        thirdInput.set("card_num", cardNum);
        thirdInput.set("card_password", cardPassword);
        thirdInput.set("bindtype", thirdBankModel.getBindType());
        thirdInterface = SpringHelper.getBean(ThirdDictionaryConstants.SERVICE_ID_THIRDINTERFACE, ThirdInterface.class);
        DataRow bindResult = thirdInterface.accountBindBankCard(thirdInput);
		/* 如果绑定失败，处理分两种情况：
		 1 如果该银行本身的三方存管绑定方式为预指定，则直接抛出异常 。
		 2 如果该银行本身的三方存管绑定方式为一步式，则取该条记录的绑定错误次数，如果绑定错误没有超过系统配置的最大错误次数，则直接去更新错误数，抛出异常  ；
		             如果绑定错误超过系统配置的最大错误次数，自动预指定，如果预指定成功，记录新银行卡信息，修改业务办理为完成，否则抛出异常*/
        if (!bindResult.getBoolean("flag"))
        {
            //1：如果用户选择的预指定则直接报错
            if (ThirdBankContants.BINDTYPE_PRE_SPECIFIED.equals(bindType))
            {
                throw new BusinessException(ThirdBankErrorCode.ADDORUPDATEUSERBANKBIND_CODE, bindResult.getString("message"));
            }
            //2：如果用户选择的一步式，则判断错误次数，超过错误次数则直接预指定
            int bindErrorCount = thirdBankBusinessInfoVo.getBindErrorCount() + 1;//计算绑定失败次数
            //如果绑定失败次数超过限制，自动预指定
            if (bindErrorCount > Configuration.getInt(ThirdBankContants.UPDATE_BANKERRORMAX))
            {
                thirdInput.remove("card_num");
                thirdInput.remove("card_password");
                thirdInput.set("bindtype", ThirdBankContants.BINDTYPE_PRE_SPECIFIED);
                DataRow yzdResult = thirdInterface.accountBindBankCard(thirdInput);
                //如果预指定失败，记录绑定错误次数，并抛出异常
                if (!yzdResult.getBoolean("flag"))
                {
                    thirdBankService.updateBindErrorCount(businessId, bindErrorCount);
                    throw new BusinessException(ThirdBankErrorCode.ADDORUPDATEUSERBANKBIND_CODE, yzdResult.getString("message"));
                }
                //如果预指定成功，记录新银行卡信息，修改业务办理为完成
                updateThirdBankBusinessInfo(newBankCode, cardNum, thirdBankBusinessInfoVo);//预指定成功是不需要记录卡号的，修改业务办理为完成
                success_type = "0";//绑定失败后，自动预指定成功

                //step11：协议留痕
                //根据用户提交的协议获取协议对象
                List<AgreeRecordModel> agreeRecordModels = signAndVerifyService.getAgreeRecordModels(userId, allSignList, businessId, BusinessConstants.BUSINESS_THIRDBANK,"");
                agreeRecordService = SpringHelper.getBean(BusinessServiceBeanIdConstants.SERVICE_ID_AGREERECORD, AgreeRecordService.class);
                agreeRecordService.addBatch(agreeRecordModels, businessId, BusinessConstants.BUSINESS_THIRDBANK);

                //添加业务办理快照
                userSnapShotService = SpringHelper.getBean(BusinessServiceBeanIdConstants.SERVICE_ID_USERSNAPSHOT, UserSnapShotService.class);
                userSnapShotService.addUserSnapShot(businessId, userInfoVo);
            }
            //错误次数也没有到达最大值，记录错误次数
            else
            {
                thirdBankService.updateBindErrorCount(businessId, bindErrorCount);
                throw new BusinessException(ThirdBankErrorCode.ADDORUPDATEUSERBANKBIND_CODE, bindResult.getString("message"));
            }

        }
        else
        {
            //如果绑定成功，记录新银行卡信息，修改业务办理为完成
            updateThirdBankBusinessInfo(newBankCode, cardNum, thirdBankBusinessInfoVo);
            success_type = "1";//正常绑定成功

            //step11：协议留痕
            //根据用户提交的协议获取协议对象
            List<AgreeRecordModel> agreeRecordModels = signAndVerifyService.getAgreeRecordModels(userId, allSignList, businessId, BusinessConstants.BUSINESS_THIRDBANK,"");
            agreeRecordService = SpringHelper.getBean(BusinessServiceBeanIdConstants.SERVICE_ID_AGREERECORD, AgreeRecordService.class);
            agreeRecordService.addBatch(agreeRecordModels, businessId, BusinessConstants.BUSINESS_THIRDBANK);

            //添加业务办理快照
            userSnapShotService = SpringHelper.getBean(BusinessServiceBeanIdConstants.SERVICE_ID_USERSNAPSHOT, UserSnapShotService.class);
            userSnapShotService.addUserSnapShot(businessId, userInfoVo);
        }

        DataRow result = new DataRow();
        result.set("success_type", success_type);
        ResultVo resultVo = new ResultVo();
        resultVo.setResult(result);
        resultVo.setErrorNo(DictionaryConstants.INVOKE_FUNCTION_SUCCESS);
        resultVo.setErrorMsg(DictionaryConstants.INVOKE_FUNCTION_SUCCESSMSG);
        return resultVo;
    }

    private void checkInput() throws InvokeException
    {
        businessId = Long.valueOf(this.getAndCheckBlankStrParam("business_id", ErrorCodeCheckInput.BLANK_BUSINESSID));
        userId = Long.valueOf(this.getAndCheckBlankStrParam("user_id", ErrorCodeCheckInput.BLANK_USERID));
        newBankConfigId = Long.valueOf(this.getAndCheckBlankStrParam("newBankConfigId", ErrorCodeCheckInput.BLANK_ENUM_BANKCONFIGID));//三方存管配置编号
        jsondata = this.getAndCheckBlankStrParam("jsondata", ErrorCodeCheckInput.BLANK_FORMAT_SIGNJSON);//签名json
        cardNum = this.getStrParameter("cardNo");//银行卡号
        cardPassword = this.getStrParameter("cardPassword");//银行卡密码
    }

    /**
     * @描述：更改三方存管业务办理信息为完成
     * @作者：田源
     * @时间：2016年9月2日 下午4:21:23
     * @param bank_code
     * @param bank_num
     * @param bankBusinessInfoVo
     * @throws Exception
     */
    private void updateThirdBankBusinessInfo(String bank_code, String bank_num, ThirdBankBusinessInfoVo bankBusinessInfoVo) throws Exception
    {
        bankBusinessInfoVo.setNodeId(DictionaryConstants.FLOW_LASTSTEP_NEXT);
        bankBusinessInfoVo.setIsComplete(DictionaryConstants.BOL_TRUE);
        bankBusinessInfoVo.setDealResult(DictionaryConstants.DEAL_RESULT_SUCCESS);
        bankBusinessInfoVo.setNewBankcode(newBankConfigId.toString());
        bankBusinessInfoVo.setNewBanknum(bank_num);
        Boolean flag = thirdBankService.updateThirdBankBusinessInfoVo(bankBusinessInfoVo);
        if (!flag)
        {
            throw new BusinessException(ThirdBankErrorCode.MODIFY_FALURE_THIRDBANK);
        }
    }

    /**
     * @描述：获取业务办理需要签署的协议信息
     * @作者：刘恺
     * @时间：2017年2月22日 下午1:12:41
     * @param thirdBankModel
     * @return
     */
    private Map<String, DataRow> getNeedSignAgereeInfo(ThirdBankModel thirdBankModel)
    {
        String agreeNos = thirdBankModel.getAgreeNo();
        String[] agreeNoArr = agreeNos.split(",");
        Map<String, DataRow> signParamsMap = new HashMap<String, DataRow>();
        for (String agreeNo : agreeNoArr)
        {
            DataRow signParams = new DataRow();
            signParams.set(AgreeNodePropertyConstants.PROPERTY_KEY_SIGNTYPE, CertConstants.SIGN_TYPE_NOCERT);//签署类型 0-不签署，1-中登证书签署，2-自建证书签署,默认值0
            signParams.set(AgreeNodePropertyConstants.PROPERTY_KEY_SUBMITTYPE, CertConstants.SUBMIT_TYPE_LOCAL);//提交方式 0-否，1-是，默认值0
            signParams.set(AgreeNodePropertyConstants.PROPERTY_KEY_SIGNTEXTTYPE, CertConstants.SIGN_SOURCE_FLAG_MD5);//签署类型 0-不签署，1-中登证书签署，2-自建证书签署,默认值0
            signParamsMap.put(agreeNo, signParams);
        }
        return signParamsMap;
    }
}
