package com.thinkive.fxc.ismp.bus.business.ggt.function;

import com.thinkive.base.exception.BusinessException;
import com.thinkive.base.util.SpringHelper;
import com.thinkive.fxc.ismp.bus.base.business.constants.BusinessServiceBeanIdConstants;
import com.thinkive.fxc.ismp.bus.base.business.function.IsmpFlowBaseFunction;
import com.thinkive.fxc.ismp.bus.base.business.model.BusinessEntityModel;
import com.thinkive.fxc.ismp.bus.base.business.service.BusinessEntityService;
import com.thinkive.fxc.ismp.bus.base.business.service.UserInfoService;
import com.thinkive.fxc.ismp.bus.base.business.vo.UserInfoVo;
import com.thinkive.fxc.ismp.bus.base.common.ISMPBaseFunction;
import com.thinkive.fxc.ismp.bus.base.constants.DictionaryConstants;
import com.thinkive.fxc.ismp.bus.base.constants.ErrorCodeCheckInput;
import com.thinkive.fxc.ismp.bus.base.constants.ErrorCodeSystem;
import com.thinkive.fxc.ismp.bus.business.ggt.contants.GgtContants;
import com.thinkive.fxc.ismp.bus.business.ggt.service.GgtService;
import com.thinkive.fxc.ismp.bus.third.constants.ThirdInterfaceConstant;
import com.thinkive.server.InvokeException;
import com.thinkive.server.ResultVo;

/**
 * @描述: 港股通-提交开通交易帐号 
 * @版权: Copyright (c) 2010
 * @公司: 深圳市思迪信息技术股份有限公司
 * @作者: 田源
 * @版本: 2.0.0 
 * @创建时间: 2016年9月9日 下午6:24:44
 */
public class Function1004208 extends IsmpFlowBaseFunction
{
    
    private Long            userId;          //用户ID
                                             
    private String          trdaccount;      //沪A帐号数组，用逗号分格   aasas,asdff  
    
    @Override
    public ResultVo execute() throws Exception
    {
        //流程入口需要数据
        checkInput();
        
        //检查用户是否存在
        UserInfoService userInfoService = SpringHelper.getBean(BusinessServiceBeanIdConstants.SERVICE_ID_USERINFO, UserInfoService.class);
        UserInfoVo userInfoVo = userInfoService.queryAndCheckUserByUserIdAndType(userId, ThirdInterfaceConstant.USER_ACCOUNT_TYPE_ZQ);
        if (userInfoVo == null)
        {
            throw new BusinessException(ErrorCodeSystem.NOTEXIST_USER, "用户不存在");
        }
        
        //查询正在办理的科创板业务数据
        BusinessEntityService businessEntityService = SpringHelper.getBean( BusinessServiceBeanIdConstants.SERVICE_ID_BUSINESSENTITY, BusinessEntityService.class);
        BusinessEntityModel businessEntityModel = businessEntityService.queryNotCompleteByUserIdAndBusinessCode(userId, GgtContants.BUSINESS_CODE);
        if(businessEntityModel == null)
        {
            throw new BusinessException(ErrorCodeSystem.BUSINESS_NOFLOW, "业务办理数据不存在");
        }
        businessEntityModel.setNodeId(submitBprocNodeConfigAndDefineVO.getNextBpNodeId());
        businessEntityModel.setIp(ip);
        businessEntityModel.setOpSource(opSource);
        businessEntityModel.setOpStation(opStation);
        
        //提交所选股东号，更新业务实例节点，并新增账号选择记录
        GgtService ggtService = SpringHelper.getBean(GgtContants.SERVER_ID_GGT, GgtService.class);
        String[] trdAccounts = trdaccount.split(",");
        
        ggtService.choiceTrdAccount(trdAccounts, businessEntityModel);
        
        ResultVo resultVo = new ResultVo();
        resultVo.setErrorNo(DictionaryConstants.INVOKE_FUNCTION_SUCCESS);
        resultVo.setErrorMsg(DictionaryConstants.INVOKE_FUNCTION_SUCCESSMSG);
        declareNotChangeNodeId();
        return resultVo;
    }
    
    /**
     * @描述：获取入参并校验
     * @作者：田源
     * @时间：2016年9月21日 下午2:25:48
     * @throws InvokeException
     */
    private void checkInput() throws InvokeException{
        userId = Long.valueOf(this.getAndCheckBlankStrParam("user_id", ErrorCodeCheckInput.BLANK_USERID));
        trdaccount = this.getAndCheckBlankStrParam("trdaccount", ErrorCodeCheckInput.BLANK_TRDACCOUNT);//沪A
    }
    
}
