package com.thinkive.fxc.ismp.bus.base.business.service.impl;

import org.apache.log4j.Logger;

import com.thinkive.base.jdbc.session.Session;
import com.thinkive.base.jdbc.session.SessionFactory;
import com.thinkive.fxc.ismp.bus.base.business.dao.UserExtendDao;
import com.thinkive.fxc.ismp.bus.base.business.dao.UserSnapShotDao;
import com.thinkive.fxc.ismp.bus.base.business.model.BusinessEntityModel;
import com.thinkive.fxc.ismp.bus.base.business.model.UserExtendModel;
import com.thinkive.fxc.ismp.bus.base.business.model.UserInfoModel;
import com.thinkive.fxc.ismp.bus.base.business.model.UserRetentionModel;
import com.thinkive.fxc.ismp.bus.base.business.model.UserSnapShotModel;
import com.thinkive.fxc.ismp.bus.base.business.service.UserSnapShotService;
import com.thinkive.fxc.ismp.bus.base.business.vo.UserInfoVo;
import com.thinkive.fxc.ismp.bus.base.constants.DictionaryConstants;
import com.thinkive.fxc.ismp.bus.base.constants.SystemConstants;
import com.thinkive.fxc.ismp.bus.business.service.impl.BusinessCommonServiceImpl;
import com.thinkive.server.InvokeException;

/**
 * @描述: 业务办理用户信息快照服务接口
 * @版权: Copyright (c) 2010
 * @公司: 深圳市思迪信息技术股份有限公司
 * @作者: 田源
 * @版本: 2.0.0 
 * @创建时间: 2016年9月7日 下午7:24:04
 */
public class UserSnapShotServiceImpl extends BusinessCommonServiceImpl implements UserSnapShotService
{
	private static Logger logger = Logger.getLogger(UserSnapShotServiceImpl.class);
	private UserExtendDao userExtendDao;
	
	private UserSnapShotDao userSnapShotDao;
	
	public void setUserExtendDao(UserExtendDao userExtendDao)
	{
		this.userExtendDao = userExtendDao;
	}
	
	public void setUserSnapShotDao(UserSnapShotDao userSnapShotDao)
	{
		this.userSnapShotDao = userSnapShotDao;
	}
	
	@Override
	public Boolean addUserSnapShot(Long businessId, UserInfoVo userInfoVo)
	{
		if (null == businessId || null == userInfoVo || null == userInfoVo.getUserId())
		{
			return false;
		}
		
		UserExtendModel userExtendModel = userExtendDao.queryByUserId(userInfoVo.getUserId());
		if (null == userExtendModel)
		{
			return false;
		}
		
		UserSnapShotModel userSnapShotModel = new UserSnapShotModel();
		userSnapShotModel.setBusinessId(businessId);
		userSnapShotModel.setIdentityType(userInfoVo.getIdentityType());
		userSnapShotModel.setIdentityNum(userInfoVo.getIdentityNum());
		userSnapShotModel.setName(userInfoVo.getName());
		userSnapShotModel.setSex(userInfoVo.getSex());
		userSnapShotModel.setEthnicName(userExtendModel.getEthnicName());
		userSnapShotModel.setBirthday(userInfoVo.getBirthday());
		userSnapShotModel.setMobile(userInfoVo.getMobile());
		userSnapShotModel.setSignOffice(userInfoVo.getSignOffice());
		userSnapShotModel.setPapersAddr(userInfoVo.getPapersAddr());
		userSnapShotModel.setValidityBegin(userInfoVo.getValidityBegin());
		userSnapShotModel.setValidityEnd(userInfoVo.getValidityEnd());
		userSnapShotModel.setTelephone(userExtendModel.getTelephone());
		userSnapShotModel.setAddress(userExtendModel.getAddress());
		userSnapShotModel.setPostCode(userExtendModel.getPostCode());
		userSnapShotModel.setOccupation(userExtendModel.getOccupation());
		userSnapShotModel.setEducation(userExtendModel.getEducation());
		userSnapShotModel.setEmail(userExtendModel.getEmail());
		userSnapShotDao.add(userSnapShotModel);
		
		return true;
	}
	
	  /**
     * @描述: 添加业务办理用户资料流水记录(支持事务)
     * @作者: MIKE
     * @时间：2017年2月20日 下午3:59:13
     * @param  UserRetentionModel
     * @return UserRetentionModel    
      */
     public boolean addUserLog(UserRetentionModel userRetentionModel)throws Exception{
 		Session session = null;
 		boolean flag=true;
 		try
 		{
 			//step1.创建session，开启事务
 			session = SessionFactory.getSession(SystemConstants.DB_ISMP);
 			session.beginTrans();
 			flag = userSnapShotDao.addUserLog(userRetentionModel, session);
 			session.commitTrans();
 		}
 		catch (Exception e)
 		{
 			flag=false;
 			if (session != null)
 			{
 				session.rollbackTrans();
 			}
 			throw e;
 		}
 		finally
 		{
 			if (session != null)
 			{
 				session.close();
 			}
 		}
    	return flag;
     }
     
     /**
 	 * 作者：MIKE
 	 * 公司：深圳市思迪信息技术股份公司
 	 * 日期时间：2018年1月10日 下午3:15:47
 	 * 说明：客户业务办理时信息记录表
 	 */
 	public boolean InsertRetention(UserInfoModel olduserInfoModel,UserExtendModel oldUserExtendModel,BusinessEntityModel businessEntityModel,UserRetentionModel userretentionmodel) throws Exception{
 		userretentionmodel.setBusinessId(businessEntityModel.getId());
 		userretentionmodel.setIdentityType(olduserInfoModel.getIdentityType());
 		userretentionmodel.setIdentityNum(olduserInfoModel.getIdentityNum());
 		userretentionmodel.setName(olduserInfoModel.getName());
 		userretentionmodel.setSex(olduserInfoModel.getSex());
 		userretentionmodel.setNationality(olduserInfoModel.getNationality());
 		userretentionmodel.setNickname(olduserInfoModel.getNickName());
 		userretentionmodel.setBirthday(olduserInfoModel.getBirthday());
 		userretentionmodel.setMobile(olduserInfoModel.getMobile());
 		userretentionmodel.setSignOffice(olduserInfoModel.getSignOffice());
 		userretentionmodel.setPapersAddr(olduserInfoModel.getPapersAddr());
 		userretentionmodel.setValidityBegin(olduserInfoModel.getValidityBegin());
 		userretentionmodel.setValidityEnd(olduserInfoModel.getValidityEnd());
 		userretentionmodel.setBranchno(olduserInfoModel.getBranchNo());
 		userretentionmodel.setClientid(olduserInfoModel.getClientId());
 		userretentionmodel.setFundaccount(olduserInfoModel.getFundaccount());

 		userretentionmodel.setEthnicName(oldUserExtendModel.getEthnicName());
 		userretentionmodel.setTelephone(oldUserExtendModel.getTelephone());
 		userretentionmodel.setEmail(oldUserExtendModel.getEmail());
 		userretentionmodel.setAddress(oldUserExtendModel.getAddress());
 		userretentionmodel.setPostCode(oldUserExtendModel.getPostCode());
 		userretentionmodel.setOccupation(oldUserExtendModel.getOccupation());
 		userretentionmodel.setEducation(oldUserExtendModel.getEducation());
 		userretentionmodel.setControlperson(oldUserExtendModel.getControlPerson());
 		userretentionmodel.setBenefitperson(oldUserExtendModel.getBenefitPerson());
 		userretentionmodel.setCreditrecord(oldUserExtendModel.getCreditrecord());
 		userretentionmodel.setBusinessCode(businessEntityModel.getBusinessCode());
 		userretentionmodel.setOpStation(businessEntityModel.getOpStation());
 		// step:4提交记录信息
 		boolean flag;
 		try {
 			 flag = this.addUserLog(userretentionmodel);
 		} catch (Exception e) {
 			logger.error("错误信息：" + e);
 			throw new InvokeException(-1, e.getMessage());
 		}
 		return flag;
 	}
}
